{% extends 'layout/base_admin.html' %}
{% from 'macros/datetime.html' import render_date, render_datetime %}
{% from 'macros/icons.html' import render_icon %}
{% from 'macros/misc.html' import render_with_fallback %}
{% from 'macros/shop_admin.html' import render_order_payment_state %}
{% from 'macros/user_admin.html' import render_user_admin_avatar %}
{% set current_page = 'user_admin' %}
{% set title = 'Benutzer - %s'|format(user.screen_name) %}

{% block head %}
<style>
  ol.toc li {
    display: inline;
    font-size: 0.9rem;
  }
  ol.toc li:not(:last-child)::after {
    content: " \00b7";
    opacity: 0.5;
  }
</style>
{% endblock %}

{% block body %}

  <h1>{{ render_icon('user') }} {{ user.screen_name }}</h1>

  <nav>
    <ol class="toc">
      <li><a href="#account">Benutzerkonto</a></li>
      <li><a href="#personal">Persönliche Daten</a></li>
      <li><a href="#permissions">Berechtigungen</a></li>
      <li><a href="#misc">Diverses</a></li>
      <li><a href="#orders">Bestellungen</a></li>
      <li><a href="#tickets">Tickets</a></li>
    </ol>
  </nav>

  <h2 id="account">Benutzerkonto</h2>
  {%- if user.has_avatar_image %}
  <div style="float: right; margin: 0 120px 0 1rem;">{{ render_user_admin_avatar(user) }}</div>
  {%- endif %}
  <table class="index">
    <tr>
      <th>ID</th>
      <td>{{ user.id }}</td>
    </tr>
    <tr>
      <th>Benutzername</th>
      <td>{{ user.screen_name }}</td>
    </tr>
    <tr>
      <th>Erstellt</th>
      <td>{{ render_datetime(user.created_at) }}</td>
    </tr>
    <tr>
      <th>E-Mail-Adresse</th>
      <td><a href="mailto:{{ user.email_address }}">{{ user.email_address }}</a></td>
    </tr>
    <tr>
      <th>Aktiviert</th>
      <td>{{ render_icon('enabled' if user.enabled else 'disabled') }}</td>
    </tr>
    <tr>
      <th>Avatar</th>
      <td>{{ render_icon('enabled' if user.has_avatar_image else 'disabled') }}</td>
    </tr>
    <tr>
      <th>Orga-Teams</th>
      <td>
        {%- if user.orga_team_memberships %}
        <ol>
          {%- for membership in user.orga_team_memberships|sort(attribute='orga_team.party.starts_at', reverse=True) %}
          <li>
            {{- membership.orga_team.party.title }} – {{ membership.orga_team.title }}
            {%- if membership.duties %} ({{ membership.duties }}){% endif -%}
          </li>
          {%- endfor %}
        </ol>
        {%- else %}
          {{- 'keine'|dim -}}
        {%- endif %}
      </td>
    </tr>
  </table>

  <h2 id="personal">Persönliche Daten</h2>
  <table class="index">
    <tr>
      <th>Voller Name</th>
      <td>{{ render_with_fallback(user.detail.full_name) }}</td>
    </tr>
    <tr>
      <th>Geburtsdatum</th>
      <td>
        {%- if user.detail.date_of_birth -%}
          {{ render_date(user.detail.date_of_birth, smart=False) }}
        {%- else -%}
          {{ 'nicht angegeben'|dim }}
        {%- endif -%}
      </td>
    </tr>
    <tr>
      <th>Anschrift</th>
      <td>
        {{- render_with_fallback(user.detail.street) }}<br>
        {%- if user.detail.zip_code %}{{ user.detail.zip_code }}{% endif %}
        {{ render_with_fallback(user.detail.city) -}}
        <br>
        {{- render_with_fallback(user.detail.country) -}}
      </td>
    </tr>
    <tr>
      <th>Telefonnummer</th>
      <td>{{ render_with_fallback(user.detail.phone_number) }}</td>
    </tr>
  </table>

  <h2 id="permissions">Berechtigungen</h2>
  <table class="index wide">
    {%- for role, permissions in permissions_by_role.items()|sort(attribute='0.title') %}
    <tr>
      <td>
        <strong>{{ role.title }}</strong><br>
        <span class="monospace">{{ role.id|dim }}</span>
      </td>
      <td>
        <ul>
          {%- for permission in permissions|sort(attribute='title') %}
          <li>{{ permission.title }} {{ '(<span class="monospace">%s</span>)'|format(permission.id)|dim }}</li>
          {%- endfor %}
        </ul>
      </td>
    </tr>
    {%- endfor %}
  </table>

  <h2 id="misc">Diverses</h2>
  <table class="index">
    <tr>
      <th>Legacy-ID</th>
      <td>{{ render_with_fallback(user.legacy_id) }}</td>
    </tr>
  </table>

  <h2 id="orders">Bestellungen</h2>
  {%- if orders %}
  <table class="index">
    <thead>
      <tr>
        <th>Zeitpunkt</th>
        <th>Party</th>
        <th>Bezahlstatus</th>
      </tr>
    </thead>
    <tbody>
      {%- for order in orders %}
      <tr>
        <td><a href="{{ url_for('shop_admin.order_view', id=order.id) }}">{{ render_datetime(order.created_at) }}</a></td>
        <td>{{ order.party.title }}</td>
        <td class="centered">{{ render_order_payment_state(order.payment_state) }}</td>
      </tr>
      {%- endfor %}
      <tr>
    </tbody>
  </table>
  {%- else %}
  {{ 'keine'|dim }}
  {%- endif %}

  <h2 id="tickets">Tickets</h2>
  <table class="index wide">
    <thead>
      <tr>
        <th>Party</th>
        <th>Kategorie</th>
        <th>ID</th>
        <th colspan="3"></th>
      </tr>
    </thead>
    <tbody>
      {%- for party, tickets in tickets|groupby(attribute='party.title')|reverse %}
        {%- for ticket in tickets|sort(attribute='created_at') %}
      <tr>
        {%- if loop.first %}
        <td rowspan="{{ tickets|length }}"><strong>{{ ticket.category.party.title }}</strong></td>
        {%- endif %}
        <td>{{ ticket.category.title }}</td>
        <td>
          {%- if ticket.used_by == user %}<strong>{% endif -%}
          <a href="{{ url_for('ticket_admin.view', id=ticket.id) }}">{{ ticket.id }}</a>
          {%- if ticket.used_by == user %}</strong>{% endif -%}
        </td>
        <td>{% if ticket.owned_by == user %}{{ render_icon('payment', title='gekauft') }}{% endif %}</td>
        <td>{% if ticket.is_seat_managed_by(user) %}{{ render_icon('seating-area', title='verwaltet Sitzplatz') }}{% endif %}</td>
        <td>{% if ticket.is_user_managed_by(user) %}{{ render_icon('user', title='verwaltet Nutzer/in') }}{% endif %}</td>
      </tr>
        {%- endfor %}
      {%- endfor %}
    </tbody>
  </table>

{%- endblock body %}
