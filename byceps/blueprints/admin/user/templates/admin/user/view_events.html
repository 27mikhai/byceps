{% extends 'layout/admin/user.html' %}
{% from 'macros/admin.html' import render_extra_in_heading %}
{% from 'macros/admin/log.html' import render_log_entry, render_log_reason, render_log_user %}
{% from 'macros/admin/user.html' import render_user_flag_deleted, render_user_flag_suspended %}
{% from 'macros/admin/user_badge.html' import render_user_badge_linked %}
{% from 'macros/icons.html' import render_icon %}
{% from 'macros/misc.html' import render_tag %}
{% set current_tab = 'events' %}
{% set current_tab_user_id = user.id %}
{% set page_title = [_('Users'), _('Events'), user.screen_name] %}
{% set layout_main_raw = True %}

{% block head %}
    <style>
      .newsletter-subscribed {
        background-color: #11aa22;
      }
      .newsletter-unsubscribed {
        background-color: #ee3322;
      }
    </style>
{%- endblock %}

{% block body %}

  <div class="row row--space-between">
    <div class="column-auto">
      <h2>{{ _('Events') }} {{ render_extra_in_heading(log_entries|length) }}</h2>
    </div>
    <div class="column-auto column--align-bottom">
      <div class="button-row button-row--right">
        {%- if logins_included %}
        <a class="button button--compact" href="{{ url_for('.view_events', user_id=user.id, include_logins='no') }}">{{ render_icon('hidden') }} <span>{{ _('Hide logins') }}</span></a>
        {%- else %}
        <a class="button button--compact" href="{{ url_for('.view_events', user_id=user.id) }}">{{ render_icon('view') }} <span>{{ _('Show logins') }}</span></a>
        {%- endif %}
      </div>
    </div>
  </div>

  <div class="box">
    <div class="events">
      {%- for log_entry in log_entries|sort(attribute='occurred_at', reverse=True) %}
        {%- if log_entry.event_type == 'user-created' %}
          {%- call render_log_entry('add', log_entry.occurred_at) %}
            {%- if log_entry.initiator is defined %}
            {{ render_log_user(log_entry.initiator) }}
            {%- else %}
            Jemand
            {%- endif %}
            hat das Benutzerkonto
            {%- if log_entry.site is defined %}
            auf Site &quot;{{ log_entry.site.title }}&quot;
            {%- endif %}
            <strong>angelegt</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-initialized' %}
          {%- call render_log_entry('enabled', log_entry.occurred_at) %}
            {%- if log_entry.initiator is defined %}
            {{ render_log_user(log_entry.initiator) }}
            {%- else %}
            Jemand
            {%- endif %}
            hat das Benutzerkonto <strong>initialisiert</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-suspended' %}
          {%- call render_log_entry('lock', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat das Benutzerkonto {{ render_user_flag_suspended() }}.
            {{ render_log_reason(log_entry.data.reason) }}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-unsuspended' %}
          {%- call render_log_entry('unlock', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat das Benutzerkonto {{ render_tag('entsperrt', icon='unlock', class='color-success') }}.
            {{ render_log_reason(log_entry.data.reason) }}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-deleted' %}
          {%- call render_log_entry('delete', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat das Benutzerkonto {{ render_user_flag_deleted() }}.
            {{ render_log_reason(log_entry.data.reason) }}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-logged-in' %}
          {%- call render_log_entry('log-in', log_entry.occurred_at) %}
            {{ render_log_user(user) }}
            hat sich von IP-Adresse {{ log_entry.data.ip_address }} <strong>erfolgreich angemeldet</strong>
            {%- if log_entry.site is defined %}
            auf Site &quot;{{ log_entry.site.title }}&quot;
            {%- endif -%}
            .
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-screen-name-changed' %}
          {%- call render_log_entry('user', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat das Benutzerkonto &quot;{{ log_entry.data.old_screen_name }}&quot; umbenannt in &quot;{{ log_entry.data.new_screen_name }}&quot;.
            {%- if 'reason' in log_entry.data %}
            {{ render_log_reason(log_entry.data.reason) }}
            {%- endif %}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-email-address-changed' %}
          {%- call render_log_entry('user', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat die E-Mail-Adresse von
            {%- if log_entry.data.old_email_address %}
            &quot;{{ log_entry.data.old_email_address }}&quot;
            {%- else %}
            <em>keine</em>
            {%- endif %}
            in
            {%- if log_entry.data.new_email_address %}
            &quot;{{ log_entry.data.new_email_address }}&quot;
            {%- else %}
            <em>keine</em>
            {%- endif %}
            geändert.
            {%- if 'reason' in log_entry.data %}
            {{ render_log_reason(log_entry.data.reason) }}
            {%- endif %}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-email-address-confirmed' %}
          {%- call render_log_entry('email', log_entry.occurred_at) %}
            {{ render_log_user(user) }}
            hat die E-Mail-Adresse {{ log_entry.data.email_address }} <strong>verifiziert</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-email-address-invalidated' %}
          {%- call render_log_entry('email', log_entry.occurred_at) %}
            {%- if log_entry.initiator is defined %}
            {{ render_log_user(log_entry.initiator) }}
            {%- else %}
            Jemand
            {%- endif %}
            hat die E-Mail-Adresse {{ log_entry.data.email_address }} <strong>invalidiert</strong>.
            {{ render_log_reason(log_entry.data.reason) }}
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-details-updated' %}
          {%- call render_log_entry('edit', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat persönliche Daten von
            {{ render_log_user(user) }}
            geändert.
            <blockquote><table>
            {%- for key, value in log_entry.details.items()|sort %}
              <tr>
                <th>{{ key }}</th>
                <td>{{ value|fallback }}</td>
              </tr>
            {%- endfor %}
            </table></blockquote>
          {%- endcall %}
        {%- elif log_entry.event_type == 'password-updated' %}
          {%- call render_log_entry('password', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat ein <strong>neues Passwort gesetzt</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-avatar-updated' %}
          {%- call render_log_entry('upload', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat ein <a href="{{ log_entry.data.url_path }}">neues Avatarbild</a> hochgeladen.
          {%- endcall %}
        {%- elif log_entry.event_type == 'consent-expressed' %}
          {%- call render_log_entry('legal', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat &quot;{{ log_entry.data.subject_title }}&quot; <strong>akzeptiert</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'privacy-policy-accepted' %}
          {%- call render_log_entry('legal', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat die <strong>Datenschutzbestimmungen akzeptiert</strong>.
          {%- endcall %}
        {%- elif log_entry.event_type == 'newsletter-requested' %}
          {%- call render_log_entry('email', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat den Newsletter &quot;{{ log_entry.data.list_.title }}&quot; {{ render_tag('angefordert', icon='success', class='newsletter-subscribed') }}.
          {%- endcall %}
        {%- elif log_entry.event_type == 'newsletter-declined' %}
          {%- call render_log_entry('email', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat den Newsletter &quot;{{ log_entry.data.list_.title }}&quot; {{ render_tag('abbestellt', icon='disabled', class='newsletter-unsubscribed') }}.
          {%- endcall %}
        {%- elif log_entry.event_type == 'order-canceled-after-paid' %}
          {%- call render_log_entry('shopping-cart', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat Bestellung <a href="{{ url_for('shop_order_admin.view', order_id=log_entry.data.order_id) }}">{{ log_entry.data.order_number }}</a>
            storniert (nach Bezahlung).
          {%- endcall %}
        {%- elif log_entry.event_type == 'order-canceled-before-paid' %}
          {%- call render_log_entry('shopping-cart', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat Bestellung <a href="{{ url_for('shop_order_admin.view', order_id=log_entry.data.order_id) }}">{{ log_entry.data.order_number }}</a>
            storniert (vor Bezahlung).
          {%- endcall %}
        {%- elif log_entry.event_type == 'order-paid' %}
          {%- call render_log_entry('shopping-cart', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat Bestellung <a href="{{ url_for('shop_order_admin.view', order_id=log_entry.data.order_id) }}">{{ log_entry.data.order_number }}</a>
            als bezahlt markiert.
          {%- endcall %}
        {%- elif log_entry.event_type == 'order-placed' %}
          {%- call render_log_entry('shopping-cart', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat Bestellung <a href="{{ url_for('shop_order_admin.view', order_id=log_entry.data.order_id) }}">{{ log_entry.data.order_number }}</a>
            aufgegeben.
          {%- endcall %}
        {%- elif log_entry.event_type == 'orgaflag-added' %}
          {%- call render_log_entry('enabled', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat
            {{ render_log_user(user) }}
            für die Marke <strong>{{ log_entry.data.brand_id }}</strong> zum Orga ernannt.
          {%- endcall %}
        {%- elif log_entry.event_type == 'orgaflag-removed' %}
          {%- call render_log_entry('disabled', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat
            {{ render_log_user(user) }}
            für die Marke <strong>{{ log_entry.data.brand_id }}</strong> den Orgastatus entzogen.
          {%- endcall %}
        {%- elif log_entry.event_type == 'role-assigned' %}
          {%- call render_log_entry('permission', log_entry.occurred_at) %}
            {%- if log_entry.initiator is defined %}
            {{ render_log_user(log_entry.initiator) }}
            {%- else %}
            Jemand
            {%- endif %}
            hat
            {{ render_log_user(user) }}
            die Rolle <strong>{{ log_entry.data.role_id }}</strong> zugewiesen.
          {%- endcall %}
        {%- elif log_entry.event_type == 'role-deassigned' %}
          {%- call render_log_entry('permission', log_entry.occurred_at) %}
            {{ render_log_user(log_entry.initiator) }}
            hat
            {{ render_log_user(user) }}
            die Rolle <strong>{{ log_entry.data.role_id }}</strong> genommen.
          {%- endcall %}
        {%- elif log_entry.event_type == 'user-badge-awarded' %}
          {%- call render_log_entry('badge', log_entry.occurred_at) %}
            {%- if log_entry.initiator is defined %}
            {{ render_log_user(log_entry.initiator) }}
            {%- else %}
            Jemand
            {%- endif %}
            hat
            {{ render_log_user(user) }}
            das Abzeichen {{ render_user_badge_linked(log_entry.badge, 24) }} <strong>{{ log_entry.badge.label }}</strong> verliehen.
          {%- endcall %}
        {%- else %}
          {%- call render_log_entry('disabled', log_entry.occurred_at) %}
            <strong>Unbekannte Aktion '{{ log_entry.event_type }}'</strong> ist ausgelöst worden.
          {%- endcall %}
        {%- endif %}
      {%- endfor %}
    </div>
  </div>

{%- endblock %}
